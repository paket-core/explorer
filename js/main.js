var imgSrcBase64 =
  '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'

var jsonData = null

var launcherData = []
var recipientData = []
var courierData = []

var launcher = {}

// var protocol = location.protocol == 'file:' ? 'http:' : location.protocol
var protocol = 'http:'
var baseUrlRouter = protocol + '//itd.pub:11250/v3'
var baseUrlBridge = protocol + '//itd.pub:11251/v3'
var baseUrlFund = protocol + '//itd.pub:11252/v2'
var dataTablePackage = null

var mapOnPackageDetailsModal = null
var markersOnPackageDetailsModal = []

var photoForCreateProject = null
var photoForLaunchModal = null
var photoForRelayModal = null
var photoForReceiveModal = null
var photoForChangeLocationModal = null

var recipientAddressAutocomplete = null
var courierAddressAutocompleteOnLaunchModal = null
var courierAddressAutocompleteOnRelayModal = null
var courierAddressAutocompleteOnReceiveModal = null
var courierAddressAutocompleteOnChangeLocationModal = null

$(document).ready(function() {
  // Configuration Stellar Network
  // StellarBase.Network.useTestNetwork()
  var network = new StellarBase.Network('Test SDF Network ; September 2015')
  StellarBase.Network.use(network)

  // Places autocomplete on create package modal
  recipientAddressAutocomplete = new google.maps.places.Autocomplete(
    $('#createPackageModal #recipientAddress')[0]
  )

  // Places autocomplete on launch modal
  courierAddressAutocompleteOnLaunchModal = new google.maps.places.Autocomplete(
    $('#launchModal #address')[0]
  )

  // Places autocomplete on launch modal
  courierAddressAutocompleteOnRelayModal = new google.maps.places.Autocomplete(
    $('#relayModal #address')[0]
  )

  // Places autocomplete on launch modal
  courierAddressAutocompleteOnReceiveModal = new google.maps.places.Autocomplete(
    $('#receiveModal #address')[0]
  )

  // Places autocomplete on launch modal
  courierAddressAutocompleteOnChangeLocationModal = new google.maps.places.Autocomplete(
    $('#changeLocationModal #address')[0]
  )

  // Description autocomplete
  var inputDescription = $('#createPackageModal #description')
  inputDescription.typeahead({
    source: [],
    autoSelect: true,
  })

  inputDescription.change(function() {
    var current = inputDescription.typeahead('getActive')
    if (current) {
      // Some item from your model is active!
      if (current.name == inputDescription.val()) {
        // This means the exact match is found. Use toLowerCase() if you want case insensitive match.
      } else {
        // This means it is only a partial match, you can either add a new item
        // or take the active if you don't want new items
      }
    } else {
      // Nothing is active so it is a new value (or maybe empty value)
    }
  })

  // Refresh DataTable
  dataTablePackage = $('#tablePackages').DataTable({
    columnDefs: [
      {
        targets: 0,
        visible: false,
      },
      {
        targets: -1,
        visible: true,
        searchable: false,
        orderable: false,
        render: function($data, $type, $row) {
          return (
            '<div class="btn-group">' +
            '<button type="button" class="launch btn btn-success" id="' +
            $row[0] +
            '">Launch</button>' +
            '<button type="button" class="relay btn btn-success" id="' +
            $row[0] +
            '">Relay</button>' +
            '<button type="button" class="receive btn btn-success" id="' +
            $row[0] +
            '">Receive</button>' +
            '<button type="button" class="changeLocation btn btn-success" id="' +
            $row[0] +
            '">Change location</button>' +
            '<button type="button" class="details btn btn-info" id="' +
            $row[0] +
            '">Details</button>' +
            '</div>'
          )
        },
      },
    ],
  })

  dataTablePackage.clear().draw()

  // Show modal window for package launch
  var packageIdForLaunch = null
  $('#tablePackages tbody').on('click', 'button.launch', function() {
    packageIdForLaunch = this.attributes.id.value

    $('#launchModal #packageId')
      .empty()
      .append(packageIdForLaunch.substr(packageIdForLaunch.length - 3))

    // Show modal window
    $('#launchModal').modal({
      show: true,
    })
  })

  $('#launchModal #launchPackage').click(function() {
    showLoadingScreen('Starting')

    // Get val from Recipient address field
    var addressVal = $('#launchModal #address').val()

    // Get place
    var place = courierAddressAutocompleteOnLaunchModal.getPlace()
    if (!addressVal || !place) {
      alert('Data is not valid. Please enter the recipient address.')
      hideLoadingScreen()
      return
    }

    var location =
      place.geometry.location.lat().toFixed(7) +
      ',' +
      place.geometry.location.lng().toFixed(7)

    var packageCurent = null
    var packages = getKeypairForPackage()

    for (var index = 0; index < packages.length; index++) {
      packageCurent = packages[index]

      if (packageCurent.escrow.publicKey == packageIdForLaunch) {
        break
      }
    }

    if (!packageCurent) {
      alert('Sorry, this package was not found in local storage.')
      hideLoadingScreen()
      return
    }

    requests.router
      .acceptPackage(
        packageCurent.courier.privateKey,
        packageCurent.courier.publicKey,
        {
          escrow_pubkey: packageIdForLaunch,
          location: location,
          leg_price: 1,
          photo: photoForLaunchModal,
        }
      )
      .done(function(response) {
        console.log(response)
        hideLoadingScreen()

        // Hide modal window
        $('#launchModal').modal('hide')
      })
      .catch(function(error) {
        console.error(error)
        alert('An error occurred while confirm couriering')
        hideLoadingScreen()
      })
  })

  // Show modal window for package relay
  var packageIdForRelay = null
  $('#tablePackages tbody').on('click', 'button.relay', function() {
    packageIdForRelay = this.attributes.id.value

    $('#relayModal #packageId')
      .empty()
      .append(packageIdForRelay.substr(packageIdForRelay.length - 3))

    // Display courier
    var courierSelect = $('#relayModal #courier')
    courierSelect.empty()

    for (var index = 0; index < courierData.length; index++) {
      var element = courierData[index]
      courierSelect.append(
        '<option value="' + index + '">' + element.name + '</option>'
      )
    }

    // Show modal window
    $('#relayModal').modal({
      show: true,
    })
  })

  $('#relayModal #relayPackage').click(function() {
    showLoadingScreen('Starting')

    // Get val from Recipient address field
    var addressVal = $('#relayModal #address').val()

    // Get place
    var place = courierAddressAutocompleteOnRelayModal.getPlace()
    if (!addressVal || !place) {
      alert('Data is not valid. Please enter the recipient address.')
      hideLoadingScreen()
      return
    }

    // Get courier
    var courierId = $('#relayModal #courier').val()
    var newCourier = courierData[courierId]

    // Get location
    var location =
      place.geometry.location.lat().toFixed(7) +
      ',' +
      place.geometry.location.lng().toFixed(7)

    // Get package
    var packageCurent = null
    var packages = getKeypairForPackage()

    for (var index = 0; index < packages.length; index++) {
      packageCurent = packages[index]

      if (packageCurent.escrow.publicKey == packageIdForRelay) {
        break
      }
    }

    if (!packageCurent) {
      alert('Sorry, this package was not found in local storage.')
      hideLoadingScreen()
      return
    }

    $('#relayModal').modal('hide')
    hideLoadingScreen()

    /*
    requests.router
      .acceptPackage(
        packageCurent.courier.privateKey,
        packageCurent.courier.publicKey,
        {
          escrow_pubkey: packageIdForRelay,
          location: location,
          leg_price: 1,
          photo: photoForLaunchModal,
        }
      )
      .done(function(response) {
        console.log(response)
        hideLoadingScreen()

        // Hide modal window
        $('#launchModal').modal('hide')
      })
      .catch(function(error) {
        console.error(error)
        alert('An error occurred while confirm couriering')
        hideLoadingScreen()
      })
    */
  })

  // Show modal window for package receive
  var packageIdForReceive = null
  $('#tablePackages tbody').on('click', 'button.receive', function() {
    packageIdForReceive = this.attributes.id.value

    $('#receiveModal #packageId')
      .empty()
      .append(packageIdForReceive.substr(packageIdForReceive.length - 3))

    // Show modal window
    $('#receiveModal').modal({
      show: true,
    })
  })

  $('#receiveModal #receivePackage').click(function() {
    showLoadingScreen()

    // Get val from Recipient address field
    var addressVal = $('#receiveModal #address').val()

    // Get place
    var place = courierAddressAutocompleteOnReceiveModal.getPlace()
    if (!addressVal || !place) {
      alert('Data is not valid. Please enter the recipient address.')
      hideLoadingScreen()
      return
    }

    // Get location
    var location =
      place.geometry.location.lat().toFixed(7) +
      ',' +
      place.geometry.location.lng().toFixed(7)

    // Get package
    var packageCurent = null
    var packages = getKeypairForPackage()

    for (var index = 0; index < packages.length; index++) {
      packageCurent = packages[index]

      if (packageCurent.escrow.publicKey == packageIdForReceive) {
        break
      }
    }

    if (!packageCurent) {
      alert('Sorry, this package was not found in local storage.')
      hideLoadingScreen()
      return
    }

    requests.router
      .getPackage({ escrow_pubkey: packageIdForReceive })
      .done(function(response) {
        console.log('get package', response)
        var package = response.package

        var escrowXdrsForPackage = null
        for (let index = 0; index < package.events.length; index++) {
          const event = package.events[index]
          if (event.event_type == 'escrow XDRs assigned') {
            escrowXdrsForPackage = JSON.parse(event.kwargs).escrow_xdrs
          }
        }

        if (escrowXdrsForPackage == null) {
          alert('The package still does not have escrow xdrs')
          return
        }

        var paymentTransaction = escrowXdrsForPackage.payment_transaction

        var signedTransaction = signTransaction(
          paymentTransaction,
          StellarBase.Keypair.fromSecret(packageCurent.recipient.privateKey)
        )

        requests.bridge
          .submitTransaction({ signedTransaction })
          .done(function(response) {
            console.debug('submit payment transaction', response)

            requests.router
              .acceptPackage(
                packageCurent.recipient.privateKey,
                packageCurent.recipient.publicKey,
                {
                  escrow_pubkey: packageIdForReceive,
                  location: location,
                  leg_price: 1,
                  photo: photoForReceiveModal,
                }
              )
              .done(function(response) {
                console.debug('submit payment transaction', response)

                hideLoadingScreen()

                // Hide modal window
                $('#receiveModal').modal('hide')
              })
              .catch(function(error) {
                console.error(error)
                alert('An error occurred while submit payment transaction')
                hideLoadingScreen()
              })
          })
          .catch(function(error) {
            console.error(error)
            alert('An error occurred while submit payment transaction')
            hideLoadingScreen()
          })
      })
      .catch(function(error) {
        console.error(error)
        alert('An error occurred while get package')
        hideLoadingScreen()
      })
  })

  // Show modal window for package change location
  var packageIdForChangeLocation = null
  $('#tablePackages tbody').on('click', 'button.changeLocation', function() {
    packageIdForChangeLocation = this.attributes.id.value

    $('#changeLocationModal #packageId')
      .empty()
      .append(
        packageIdForChangeLocation.substr(packageIdForChangeLocation.length - 3)
      )

    // Show modal window
    $('#changeLocationModal').modal({
      show: true,
    })
  })

  $('#changeLocationModal #changeLocationPackage').click(function() {
    showLoadingScreen('Starting')

    // Get val from Recipient address field
    var addressVal = $('#changeLocationModal #address').val()

    // Get place
    var place = courierAddressAutocompleteOnChangeLocationModal.getPlace()
    if (!addressVal || !place) {
      alert('Data is not valid. Please enter the recipient address.')
      hideLoadingScreen()
      return
    }

    // Get location
    var location =
      place.geometry.location.lat().toFixed(7) +
      ',' +
      place.geometry.location.lng().toFixed(7)

    // Get package
    var packageCurent = null
    var packages = getKeypairForPackage()

    for (var index = 0; index < packages.length; index++) {
      packageCurent = packages[index]

      if (packageCurent.escrow.publicKey == packageIdForChangeLocation) {
        break
      }
    }

    if (!packageCurent) {
      alert('Sorry, this package was not found in local storage.')
      hideLoadingScreen()
      return
    }

    $('#changeLocationModal').modal('hide')
    hideLoadingScreen()

    requests.router
      .changedLocation(
        packageCurent.courier.privateKey,
        packageCurent.courier.publicKey,
        {
          escrow_pubkey: packageIdForChangeLocation,
          location: location,
          photo: photoForChangeLocationModal,
        }
      )
      .done(function(response) {
        console.log(response)
        hideLoadingScreen()

        // Hide modal window
        $('#launchModal').modal('hide')
      })
      .catch(function(error) {
        console.error(error)
        alert('An error occurred while confirm couriering')
        hideLoadingScreen()
      })
  })

  // Show modal window for package details
  $('#tablePackages tbody').on('click', 'button.details', function() {
    showLoadingScreen()

    var escrow_pubkey = this.attributes.id.value
    requests.router
      .getPackage({ escrow_pubkey })
      .done(function(response) {
        var package = response.package

        // Show modal window
        $('#packageDetailsModal').modal({
          show: true,
        })

        $('#packageDetailsModal').on('shown.bs.modal', function() {
          if (!mapOnPackageDetailsModal) {
            mapOnPackageDetailsModal = L.map('map').setView([0, 0], 1)
            var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
              maxZoom: 18,
              attribution:
                '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
            })
            mapOnPackageDetailsModal.addLayer(tiles)
          }

          // Remove all markers
          for (
            let index = 0;
            index < markersOnPackageDetailsModal.length;
            index++
          ) {
            const element = markersOnPackageDetailsModal[index]
            mapOnPackageDetailsModal.removeLayer(element)
          }
          markersOnPackageDetailsModal = []

          // Display marker on map
          var location = package.from_location.split(',')
          var marker = L.marker([location[0], location[1]]).addTo(
            mapOnPackageDetailsModal
          )
          mapOnPackageDetailsModal.setView([location[0], location[1]], 7)
          markersOnPackageDetailsModal.push(marker)

          // Display text
          var packageId = package.escrow_pubkey
          var shortPackageId =
            package.from_address.split(' ')[0] +
            '-' +
            packageId.substr(packageId.length - 3)

          $('#packageDetailsModal #name')
            .empty()
            .append(shortPackageId)

          $('#packageDetailsModal #description')
            .empty()
            .append(package.description)

          $('#packageDetailsModal #paketUrl').attr('href', package.paket_url)

          $('#packageDetailsModal #deadline')
            .empty()
            .append(dateToYMD(new Date(package.deadline * 1000)))

          // Get all packages for this user
          requests.router
            .getPackagePhoto({ escrow_pubkey: packageId })
            .done(function(data) {
              var photo = data.package_photo
                ? data.package_photo.photo
                : imgSrcBase64

              $('#packageDetailsModal #img').attr(
                'src',
                'data:image/png;base64,' + photo
              )
            })
            .catch(function(error) {
              alert('Error getting Packages info')
              hideLoadingScreen()
              console.error(error)
            })

          hideLoadingScreen()
        })
      })
      .catch(function(error) {
        alert('Error getting Packages info')
        hideLoadingScreen()
        console.error(error)
      })
  })

  $('#panelCustomerData .input-file').before(function() {
    if (
      !$(this)
        .prev()
        .hasClass('input-ghost')
    ) {
      var element = $(
        "<input type='file' class='input-ghost' style='visibility:hidden; height:0' accept='.json, .txt'>"
      )
      element.attr('name', $(this).attr('name'))
      element.change(function(e) {
        element
          .next(element)
          .find('input')
          .val(
            element
              .val()
              .split('\\')
              .pop()
          )

        var fileReader = new FileReader()
        fileReader.onload = function(progressEvent) {
          try {
            var json = progressEvent.target.result
            jsonData = JSON.parse(json)
          } catch (error) {
            alert('Problems reading the JSON file. Details in console.')
            console.error(error)
          }
        }
        fileReader.readAsText(e.target.files[0], 'UTF-8')
      })
      $(this)
        .find('button.btn-choose')
        .click(function() {
          element.click()
        })
      $(this)
        .find('button.btn-reset')
        .click(function() {
          element.val(null)
          $(this)
            .parents('.input-file')
            .find('input')
            .val('')
        })
      $(this)
        .find('input')
        .css('cursor', 'pointer')
      $(this)
        .find('input')
        .mousedown(function() {
          $(this)
            .parents('.input-file')
            .prev()
            .click()
          return false
        })
      return element
    }
  })

  $('#createPackageModal .uploadPhoto').before(function() {
    if (
      !$(this)
        .prev()
        .hasClass('input-ghost')
    ) {
      var element = $(
        "<input type='file' class='input-ghost' style='visibility:hidden; height:0' accept='image/*'>"
      )
      element.attr('name', $(this).attr('name'))
      element.change(function(e) {
        element
          .next(element)
          .find('input')
          .val(
            element
              .val()
              .split('\\')
              .pop()
          )

        photoForCreateProject = e.target.files[0]
      })

      $(this)
        .find('button.btn-choose')
        .click(function() {
          element.click()
        })

      $(this)
        .find('input')
        .css('cursor', 'pointer')

      $(this)
        .find('input')
        .mousedown(function() {
          $(this)
            .parents('.uploadPhoto')
            .prev()
            .click()
          return false
        })

      return element
    }
  })

  $('#launchModal .uploadPhoto').before(function() {
    if (
      !$(this)
        .prev()
        .hasClass('input-ghost')
    ) {
      var element = $(
        "<input type='file' class='input-ghost' style='visibility:hidden; height:0' accept='image/*'>"
      )
      element.attr('name', $(this).attr('name'))
      element.change(function(e) {
        element
          .next(element)
          .find('input')
          .val(
            element
              .val()
              .split('\\')
              .pop()
          )

        photoForLaunchModal = e.target.files[0]
      })

      $(this)
        .find('button.btn-choose')
        .click(function() {
          element.click()
        })

      $(this)
        .find('input')
        .css('cursor', 'pointer')

      $(this)
        .find('input')
        .mousedown(function() {
          $(this)
            .parents('.uploadPhoto')
            .prev()
            .click()
          return false
        })

      return element
    }
  })

  $('#relayModal .uploadPhoto').before(function() {
    if (
      !$(this)
        .prev()
        .hasClass('input-ghost')
    ) {
      var element = $(
        "<input type='file' class='input-ghost' style='visibility:hidden; height:0' accept='image/*'>"
      )
      element.attr('name', $(this).attr('name'))
      element.change(function(e) {
        element
          .next(element)
          .find('input')
          .val(
            element
              .val()
              .split('\\')
              .pop()
          )

        photoForRelayModal = e.target.files[0]
      })

      $(this)
        .find('button.btn-choose')
        .click(function() {
          element.click()
        })

      $(this)
        .find('input')
        .css('cursor', 'pointer')

      $(this)
        .find('input')
        .mousedown(function() {
          $(this)
            .parents('.uploadPhoto')
            .prev()
            .click()
          return false
        })

      return element
    }
  })

  $('#receiveModal .uploadPhoto').before(function() {
    if (
      !$(this)
        .prev()
        .hasClass('input-ghost')
    ) {
      var element = $(
        "<input type='file' class='input-ghost' style='visibility:hidden; height:0' accept='image/*'>"
      )
      element.attr('name', $(this).attr('name'))
      element.change(function(e) {
        element
          .next(element)
          .find('input')
          .val(
            element
              .val()
              .split('\\')
              .pop()
          )

        photoForReceiveModal = e.target.files[0]
      })

      $(this)
        .find('button.btn-choose')
        .click(function() {
          element.click()
        })

      $(this)
        .find('input')
        .css('cursor', 'pointer')

      $(this)
        .find('input')
        .mousedown(function() {
          $(this)
            .parents('.uploadPhoto')
            .prev()
            .click()
          return false
        })

      return element
    }
  })

  $('#changeLocationModal .uploadPhoto').before(function() {
    if (
      !$(this)
        .prev()
        .hasClass('input-ghost')
    ) {
      var element = $(
        "<input type='file' class='input-ghost' style='visibility:hidden; height:0' accept='image/*'>"
      )
      element.attr('name', $(this).attr('name'))
      element.change(function(e) {
        element
          .next(element)
          .find('input')
          .val(
            element
              .val()
              .split('\\')
              .pop()
          )

        photoForChangeLocationModal = e.target.files[0]
      })

      $(this)
        .find('button.btn-choose')
        .click(function() {
          element.click()
        })

      $(this)
        .find('input')
        .css('cursor', 'pointer')

      $(this)
        .find('input')
        .mousedown(function() {
          $(this)
            .parents('.uploadPhoto')
            .prev()
            .click()
          return false
        })

      return element
    }
  })

  $('#applyCustomerData').click(function() {
    for (var index = 0; index < jsonData.length; index++) {
      var item = jsonData[index]
      jsonData[index].keypairStellar = generateKeypairStellar(item)

      if (item.type == 'LAUNCHER') {
        launcherData.push(item)
      } else if (item.type == 'RECIPIENT') {
        recipientData.push(item)
      } else if (item.type == 'COURIER') {
        courierData.push(item)
      }
    }

    for (var index = 0; index < launcherData.length; index++) {
      var item = launcherData[index]

      $('#dropdownUsers').append(
        '<li><a href="#" id="' + index + '">' + item.name + '</a></li>'
      )

      $('#dropdownUsers li a:eq(' + index + ')').click(item, function(event) {
        dataTablePackage.clear().draw()

        changeSelectedLauncher(event.data)
        displayPackagesForLauncher()
      })
    }

    // the first user is selected by default
    changeSelectedLauncher(launcherData[0])
    displayPackagesForLauncher()

    $('.dropdown-toggle').dropdown()
    $('#panelCustomerData').hide()
    $('#panelRequests').show()
  })

  $('#addEvent #tryItOut').click(function() {
    var selectorPanel = '#addEvent '

    var data = {
      event_type: $(selectorPanel + '#eventType').val(),
      location: $(selectorPanel + '#location').val(),
    }

    requestToServer({
      uri: '/v3/add_event',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#acceptPackage #tryItOut').click(function() {
    var selectorPanel = '#acceptPackage '

    var data = {
      escrow_pubkey: $(selectorPanel + '#escrowPubkey').val(),
      location: $(selectorPanel + '#location').val(),
    }

    requestToServer({
      uri: '/v3/accept_package',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#assignPackage #tryItOut').click(function() {
    var selectorPanel = '#assignPackage '

    var data = {
      escrow_pubkey: $(selectorPanel + '#escrowPubkey').val(),
      location: $(selectorPanel + '#location').val(),
    }

    requestToServer({
      uri: '/v3/assign_package',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#assignXdrs #tryItOut').click(function() {
    var selectorPanel = '#assignXdrs '

    var data = {
      escrow_pubkey: $(selectorPanel + '#escrowPubkey').val(),
      location: $(selectorPanel + '#location').val(),
      kwargs: $(selectorPanel + '#kwargs').val(),
    }

    requestToServer({
      uri: '/v3/assign_xdrs',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#availablePackages #tryItOut').click(function() {
    var selectorPanel = '#availablePackages '

    var data = {
      escrow_pubkey: $(selectorPanel + '#escrowPubkey').val(),
      location: $(selectorPanel + '#location').val(),
      kwargs: $(selectorPanel + '#kwargs').val(),
    }

    requestToServer({
      uri: '/v3/available_packages',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#changedLocation #tryItOut').click(function() {
    var selectorPanel = '#changedLocation '

    var data = {
      escrow_pubkey: $(selectorPanel + '#escrowPubkey').val(),
      location: $(selectorPanel + '#location').val(),
    }

    requestToServer({
      uri: '/v3/changed_location',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#createPackage #tryItOut').click(function() {
    var selectorPanel = '#createPackage '

    var data = {
      escrow_pubkey: $(selectorPanel + '#escrowPubkey').val(),
      recipient_pubkey: $(selectorPanel + '#recipientPubkey').val(),
      launcher_phone_number: $(selectorPanel + '#launcherPhoneNumber').val(),
      recipient_phone_number: $(selectorPanel + '#recipientPhoneNumber').val(),
      payment_buls: $(selectorPanel + '#paymentBuls').val(),
      collateral_buls: $(selectorPanel + '#collateralBuls').val(),
      deadline_timestamp: $(selectorPanel + '#deadlineTimestamp').val(),
      description: $(selectorPanel + '#description').val(),
      from_location: $(selectorPanel + '#fromLocation').val(),
      to_location: $(selectorPanel + '#foLocation').val(),
      from_address: $(selectorPanel + '#fromAddress').val(),
      to_address: $(selectorPanel + '#toAddress').val(),
      event_location: $(selectorPanel + '#eventLocation').val(),
    }

    requestToServer({
      uri: '/v3/create_package',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#events #tryItOut').click(function() {
    var selectorPanel = '#events '

    var data = {}

    requestToServer({
      uri: '/v3/events',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#myPackages #tryItOut').click(function() {
    var selectorPanel = '#myPackages '

    var data = {}

    requestToServer({
      uri: '/v3/my_packages',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#package #tryItOut').click(function() {
    var selectorPanel = '#package '

    var data = {
      escrow_pubkey: $(selectorPanel + '#escrowPubkey').val(),
    }

    requestToServer({
      uri: '/v3/package',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#packagePhoto #tryItOut').click(function() {
    var selectorPanel = '#packagePhoto '

    var data = {
      escrow_pubkey: $(selectorPanel + '#escrowPubkey').val(),
    }

    requestToServer({
      uri: '/v3/package_photo',
      data: data,
      response: function(result) {
        printResponse(selectorPanel, result)
      },
    })
  })

  $('#info #openCreatePackageModal').click(function() {
    $('#createPackageModal #description').val('')
    $('#createPackageModal #recipientAddress').val('')

    var recipientSelect = $('#createPackageModal #recipient')
    recipientSelect.empty()

    var courierSelect = $('#createPackageModal #courier')
    courierSelect.empty()

    // Recipient in modal window
    for (var index = 0; index < recipientData.length; index++) {
      var element = recipientData[index]

      recipientSelect.append(
        '<option value="' + index + '">' + element.name + '</option>'
      )
    }

    // Courier in modal window
    for (var index = 0; index < courierData.length; index++) {
      var element = courierData[index]
      courierSelect.append(
        '<option value="' + index + '">' + element.name + '</option>'
      )
    }

    // Set new description to autocomplete
    $('#createPackageModal #description').data(
      'typeahead'
    ).source = getDescriptionForCreatePackage()

    // Show modal window
    $('#createPackageModal').modal()
  })

  $('#createPackageModal #createPackage').click(function() {
    showLoadingScreen('Starting')

    var selectorPanel = '#createPackageModal '

    // Get recipient
    var recipientId = $(selectorPanel + '#recipient').val()
    var recipientUser = recipientData[recipientId]

    // Get val from Recipient address field
    var recipientAddressVal = $(selectorPanel + '#recipientAddress').val()

    // Get recipient place
    var recipientPlace = recipientAddressAutocomplete.getPlace()
    if (!recipientAddressVal || !recipientPlace) {
      alert('Data is not valid. Please enter the recipient address.')
      hideLoadingScreen()
      return
    }

    var recipientAddress = recipientPlace.formatted_address
    var recipientLocation =
      recipientPlace.geometry.location.lat().toFixed(7) +
      ',' +
      recipientPlace.geometry.location.lng().toFixed(7)

    // Get courier
    var courierId = $(selectorPanel + '#courier').val()
    var courierUser = courierData[courierId]

    // Get deadline
    var deadline = $(selectorPanel + 'input[name=deadline]:checked').val()

    // Get date
    var today = new Date()
    if (deadline == '1Day') {
      // 1 day from now
      var deadlineUnixTimestamp =
        new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate() + 1
        ).getTime() / 1000
    } else if (deadline == '1Week') {
      // 1 week from now
      var deadlineUnixTimestamp =
        new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate() + 7
        ).getTime() / 1000
    } else if (deadline == '2Week') {
      // 2 week from now
      var deadlineUnixTimestamp =
        new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate() + 14
        ).getTime() / 1000
    }

    // Get values
    var paymentBuls = $(selectorPanel + 'input[name=paymentBuls]:checked').val()
    var collateralBuls = $(
      selectorPanel + 'input[name=collateralBuls]:checked'
    ).val()

    // Get fragile
    var fragile = $(selectorPanel + '#isFragile')[0].checked ? 'fragile' : null

    // Get description type
    var descriptionType = $(
      selectorPanel + 'input[name=descriptionType]:checked'
    ).val()

    // Get description
    var descriptionText = $(selectorPanel + '#enterMessageCheckBox')[0].checked
      ? $(selectorPanel + '#description').val()
      : null

    saveDescriptionForCreatePackage(descriptionText)

    // Message for a descriptive
    var description = [descriptionType, fragile, descriptionText]
      .filter(Boolean)
      .join(', ')

    // 1) Create a pubkey for the escrow
    // generate new Keypair
    infoLoadingScreen('1/14 Create a pubkey for the escrow')
    var escrowKeypair = StellarBase.Keypair.random()
    var escrowPubkey = escrowKeypair.publicKey()
    var escrowSecret = escrowKeypair.secret()
    console.debug('escrowKeypair', escrowKeypair)

    // 2) Call prepare_account on bridge as current user (launcher), sign and submit the tx to bridge
    infoLoadingScreen('2/14 Prepare account')
    requests.bridge
      .prepareAccount({
        from_pubkey: launcher.keypairStellar.publicKey(),
        new_pubkey: escrowPubkey,
      })
      .done(function(response) {
        console.debug('prepare_account', response)
        var signedTransaction = signTransaction(
          response.transaction,
          launcher.keypairStellar
        )
        // Submit transaction
        infoLoadingScreen('3/14 Submit Prepare account')
        requests.bridge
          .submitTransaction({ signedTransaction })
          .done(function(response) {
            console.debug('submit prepare_account', response)
            // 3) Call prepare_trust on bridge as escrow account (launcher), sign and submit the tx to bridge
            infoLoadingScreen('4/14 Prepare trust')
            requests.bridge
              .prepareTrust({
                from_pubkey: escrowPubkey,
              })
              .done(function(response) {
                console.debug('prepare_trust', response)
                var signedTransaction = signTransaction(
                  response.transaction,
                  escrowKeypair
                )
                // Submit transaction
                infoLoadingScreen('5/14 Submit Prepare trust')
                requests.bridge
                  .submitTransaction({ signedTransaction })
                  .done(function(response) {
                    console.debug('submit prepare_trust', response)
                    // 4) Call prepare_escrow on bridge as escrow account, sign and submit the tx to bridge
                    infoLoadingScreen('6/14 Prepare escrow')
                    requests.bridge
                      .prepareEscrow(escrowSecret, escrowPubkey, {
                        launcher_pubkey: launcher.keypairStellar.publicKey(),
                        courier_pubkey: courierUser.keypairStellar.publicKey(),
                        recipient_pubkey: recipientUser.keypairStellar.publicKey(),
                        payment_buls: paymentBuls,
                        collateral_buls: collateralBuls,
                        deadline_timestamp: deadlineUnixTimestamp,
                      })
                      .done(function(response) {
                        var signedTransaction = signTransaction(
                          response.escrow_details.set_options_transaction,
                          escrowKeypair
                        )

                        console.debug('prepare_escrow', response)

                        var XDRs = {
                          escrow_xdrs: {
                            merge_transaction:
                              response.escrow_details.merge_transaction,
                            payment_transaction:
                              response.escrow_details.payment_transaction,
                            refund_transaction:
                              response.escrow_details.refund_transaction,
                            set_options_transaction:
                              response.escrow_details.set_options_transaction,
                          },
                        }

                        // Submit transaction
                        infoLoadingScreen('7/14 Submit Prepare escrow')
                        requests.bridge
                          .submitTransaction({ signedTransaction })
                          .done(function(response) {
                            console.debug('submit prepare_escrow', response)
                            // 5) Call prepare_send_buls on bridge with the payment amount as the current user (launcher), sign and submit the tx to bridge
                            infoLoadingScreen('8/14 Prepare send buls')
                            requests.bridge
                              .prepareSendBuls({
                                from_pubkey: launcher.keypairStellar.publicKey(),
                                to_pubkey: escrowPubkey,
                                amount_buls: paymentBuls,
                              })
                              .done(function(response) {
                                var signedTransaction = signTransaction(
                                  response.transaction,
                                  launcher.keypairStellar
                                )
                                console.debug(
                                  'prepare_send_buls (payment)',
                                  response
                                )
                                // Submit transaction
                                infoLoadingScreen(
                                  '9/14 Submit Prepare send buls'
                                )
                                requests.bridge
                                  .submitTransaction({ signedTransaction })
                                  .done(function(response) {
                                    console.debug(
                                      'submit prepare_send_buls (payment)',
                                      response
                                    )
                                    // 6) Call prepare_send_buls on bridge with the collateral amount as the designated courier, sign and submit the tx to bridge
                                    infoLoadingScreen(
                                      '10/14 Second Prepare send buls'
                                    )
                                    requests.bridge
                                      .prepareSendBuls({
                                        from_pubkey: courierUser.keypairStellar.publicKey(),
                                        to_pubkey: escrowPubkey,
                                        amount_buls: collateralBuls,
                                      })
                                      .done(function(response) {
                                        var signedTransaction = signTransaction(
                                          response.transaction,
                                          courierUser.keypairStellar
                                        )
                                        console.debug(
                                          'prepare_send_buls (collateral)',
                                          response
                                        )
                                        // Submit transaction
                                        infoLoadingScreen(
                                          '11/14 Submit Second Prepare send buls'
                                        )
                                        requests.bridge
                                          .submitTransaction({
                                            signedTransaction,
                                          })
                                          .done(function(response) {
                                            console.debug(
                                              'submit prepare_send_buls (collateral)',
                                              response
                                            )
                                            // 7) Call create_package on router
                                            infoLoadingScreen(
                                              '12/14 Create package'
                                            )
                                            requests.router
                                              .createPackage({
                                                escrow_pubkey: escrowPubkey,
                                                recipient_pubkey: recipientUser.keypairStellar.publicKey(),
                                                launcher_phone_number:
                                                  launcher.phoneNumber,
                                                recipient_phone_number:
                                                  recipientUser.phoneNumber,
                                                payment_buls: paymentBuls,
                                                collateral_buls: collateralBuls,
                                                deadline_timestamp: deadlineUnixTimestamp,
                                                description: description,
                                                from_location:
                                                  launcher.location,
                                                to_location: recipientLocation,
                                                from_address: launcher.address,
                                                to_address: recipientAddress,
                                                event_location:
                                                  launcher.location,
                                                photo: photoForCreateProject,
                                              })
                                              .done(function(response) {
                                                // Save escrow Pubkey/Secret (escrowKeypair) to local storage
                                                saveKeypairForPackage(
                                                  escrowKeypair,
                                                  courierUser.keypairStellar,
                                                  launcher.keypairStellar,
                                                  recipientUser.keypairStellar
                                                )
                                                console.debug(
                                                  'create_package',
                                                  response
                                                )

                                                addRowPackagesToDataTable(
                                                  response.package
                                                )

                                                // clear field for photo
                                                photoForCreateProject = null

                                                // 8) Call confirm_couriering on router
                                                infoLoadingScreen(
                                                  '13/14 Confirming package by courier'
                                                )
                                                requests.router
                                                  .confirmCouriering(
                                                    courierUser.keypairStellar.secret(),
                                                    courierUser.keypairStellar.publicKey(),
                                                    {
                                                      escrow_pubkey: escrowPubkey,
                                                      location:
                                                        launcher.location,
                                                    }
                                                  )
                                                  .done(function(response) {
                                                    // 9) Call assign_xdrs on router
                                                    infoLoadingScreen(
                                                      '14/14 Preparing escrow and assigning XDRs'
                                                    )
                                                    requests.router
                                                      .assignXdrs(
                                                        launcher.keypairStellar.secret(),
                                                        launcher.keypairStellar.publicKey(),
                                                        {
                                                          escrow_pubkey: escrowPubkey,
                                                          location:
                                                            launcher.location,
                                                          kwargs: JSON.stringify(
                                                            XDRs
                                                          ),
                                                        }
                                                      )
                                                      .done(function(response) {
                                                        assignXdrs

                                                        // Hide modal window
                                                        $(
                                                          '#createPackageModal'
                                                        ).modal('hide')

                                                        hideLoadingScreen()
                                                      })
                                                      .catch(function(error) {
                                                        console.error(error)
                                                        alert(
                                                          'An error occurred while confirm couriering'
                                                        )
                                                        hideLoadingScreen()
                                                      })
                                                  })
                                                  .catch(function(error) {
                                                    console.error(error)
                                                    alert(
                                                      'An error occurred while confirm couriering'
                                                    )
                                                    hideLoadingScreen()
                                                  })
                                              })
                                              .catch(function(error) {
                                                console.error(error)
                                                alert(
                                                  'An error occurred while creating the Package'
                                                )
                                                hideLoadingScreen()
                                              })
                                          })
                                          .catch(function(error) {
                                            var errorMessage =
                                              'Error on step: "Submit transaction -> prepare_account on bridge"'

                                            console.error(errorMessage)
                                            console.error(error)

                                            alert(errorMessage)
                                            hideLoadingScreen()
                                          })
                                      })
                                      .catch(function(error) {
                                        var errorMessage =
                                          'Error on step: "Submit transaction -> prepare_account on bridge"'

                                        console.error(errorMessage)
                                        console.error(error)

                                        alert(errorMessage)
                                        hideLoadingScreen()
                                      })
                                  })
                                  .catch(function(error) {
                                    var errorMessage =
                                      'Error on step: "Submit transaction -> prepare_account on bridge"'

                                    console.error(errorMessage)
                                    console.error(error)

                                    alert(errorMessage)
                                    hideLoadingScreen()
                                  })
                              })
                              .catch(function(error) {
                                var errorMessage =
                                  'Error on step: "Submit transaction -> prepare_account on bridge"'

                                console.error(errorMessage)
                                console.error(error)

                                alert(errorMessage)
                                hideLoadingScreen()
                              })
                          })
                          .catch(function(error) {
                            var errorMessage =
                              'Error on step: "Submit transaction -> prepare_account on bridge"'

                            console.error(errorMessage)
                            console.error(error)

                            alert(errorMessage)
                            hideLoadingScreen()
                          })
                      })
                      .catch(function(error) {
                        var errorMessage =
                          'Error on step: "Submit transaction -> prepare_account on bridge"'

                        console.error(errorMessage)
                        console.error(error)

                        alert(errorMessage)
                        hideLoadingScreen()
                      })
                  })
                  .catch(function(error) {
                    var errorMessage =
                      'Error on step: "Submit transaction -> prepare_account on bridge"'

                    console.error(errorMessage)
                    console.error(error)

                    alert(errorMessage)
                    hideLoadingScreen()
                  })
              })
              .catch(function(error) {
                var errorMessage =
                  'Error on step: "Submit transaction -> prepare_account on bridge"'

                console.error(errorMessage)
                console.error(error)

                alert(errorMessage)
                hideLoadingScreen()
              })
          })
          .catch(function(error) {
            var errorMessage =
              'Error on step: "Submit transaction -> prepare_account on bridge"'

            console.error(errorMessage)
            console.error(error)

            alert(errorMessage)
            hideLoadingScreen()
          })
      })
      .catch(function(error) {
        var errorMessage = 'Error on step: "Call prepare_account on bridge"'

        console.error(errorMessage)
        console.error(error)

        alert(errorMessage)
        hideLoadingScreen()
      })
  })
})

function changeSelectedLauncher(user) {
  launcher = user

  var tablePackages = $('#tablePackages tbody')
  tablePackages.empty()

  // Change display info about user
  $('#userName')
    .empty()
    .append(user.name)

  $('#publicKey')
    .empty()
    .append(user.keypairStellar.publicKey())
}

function displayPackagesForLauncher() {
  // Get all packages for this user
  requests.router
    .getMyPackages()
    .done(function(data) {
      for (var index = 0; index < data.packages.length; index++) {
        var packageItem = data.packages[index]
        addRowPackagesToDataTable(packageItem)
      }
    })
    .catch(function(error) {
      console.error(error)
      alert('Failed to get data from server')
    })
}

function addRowPackagesToDataTable(package) {
  var packageId = package.escrow_pubkey

  var shortPackageId =
    package.from_address.split(' ')[0] +
    '-' +
    packageId.substr(packageId.length - 3)

  var userRole = package.user_role || 'launcher'

  var launchDate = package.launch_date

  var recipientsLocation = package.from_location

  var courieredEvent = package.events
    .filter(event => event.event_type == 'couriered')
    .last()

  var receivedEvent = package.events
    .filter(event => event.event_type == 'received')
    .last()

  var launchedEvent = package.events
    .filter(event => event.event_type == 'launched')
    .last()

  var currentCustodianPackage = (
    courieredEvent ||
    receivedEvent ||
    launchedEvent
  ).user_pubkey

  dataTablePackage.row
    .add([
      packageId,
      shortPackageId,
      userRole,
      launchDate,
      recipientsLocation,
      currentCustodianPackage,
    ])
    .draw(true)
}

function generateKeypairStellar(user) {
  try {
    var keypair = StellarBase.Keypair.fromSecret(user.privateKey)
    return keypair
  } catch (error) {
    console.error(error)
    alert('User with name "' + user.name + '" contains not corect private key')

    return null
  }
}

var requests = {
  router: {
    baseUrl: baseUrlRouter,
    getMyPackages: function() {
      return new_requestToServer(
        launcher.keypairStellar.secret(),
        launcher.keypairStellar.publicKey(),
        {
          url: this.baseUrl + '/my_packages',
        }
      )
    },
    getPackage: function({ escrow_pubkey }) {
      return new_requestToServer(
        launcher.keypairStellar.secret(),
        launcher.keypairStellar.publicKey(),
        {
          url: this.baseUrl + '/package',
          data: {
            escrow_pubkey,
          },
        }
      )
    },
    getPackagePhoto: function({ escrow_pubkey }) {
      return new_requestToServer(
        launcher.keypairStellar.secret(),
        launcher.keypairStellar.publicKey(),
        {
          url: this.baseUrl + '/package_photo',
          data: {
            escrow_pubkey,
          },
        }
      )
    },
    createPackage: function({
      escrow_pubkey,
      recipient_pubkey,
      launcher_phone_number,
      recipient_phone_number,
      payment_buls,
      collateral_buls,
      deadline_timestamp,
      description,
      from_location,
      to_location,
      from_address,
      to_address,
      event_location,
      photo,
    }) {
      var data = {
        escrow_pubkey,
        recipient_pubkey,
        launcher_phone_number,
        recipient_phone_number,
        payment_buls,
        collateral_buls,
        deadline_timestamp,
        description,
        from_location,
        to_location,
        from_address,
        to_address,
        event_location,
      }
      if (photo) {
        data.photo = photo
      }

      return new_requestToServer(
        launcher.keypairStellar.secret(),
        launcher.keypairStellar.publicKey(),
        {
          url: this.baseUrl + '/create_package',
          data: data,
        }
      )
    },
    confirmCouriering: function(
      userSecret,
      userPubkey,
      { escrow_pubkey, location }
    ) {
      return new_requestToServer(userSecret, userPubkey, {
        url: this.baseUrl + '/confirm_couriering',
        data: {
          escrow_pubkey, // escrow pubkey (the package ID)
          location, // location of place where user choose package to be courier in
        },
      })
    },
    assignXdrs: function(
      userSecret,
      userPubkey,
      { escrow_pubkey, location, kwargs }
    ) {
      return new_requestToServer(userSecret, userPubkey, {
        url: this.baseUrl + '/assign_xdrs',
        data: {
          escrow_pubkey, // escrow pubkey (the package ID)
          location, // location of place where user accepted package
          kwargs, // XDRs transaction in JSON format
        },
      })
    },
    acceptPackage: function(
      userSecret,
      userPubkey,
      { escrow_pubkey, location, leg_price, photo }
    ) {
      return new_requestToServer(userSecret, userPubkey, {
        url: this.baseUrl + '/accept_package',
        data: {
          escrow_pubkey, // escrow pubkey (the package ID)
          location, // location of place where user accepted package
          leg_price, // leg price
          // photo, // Comment this because I get an error: "accept_package_handler() got an unexpected keyword argument 'photo'"
        },
      })
    },
    changedLocation: function(
      userSecret,
      userPubkey,
      { escrow_pubkey, location, photo }
    ) {
      return new_requestToServer(userSecret, userPubkey, {
        url: this.baseUrl + '/changed_location',
        data: {
          escrow_pubkey, // pubkey of package escrow
          location, // GPS coordinates where user is at this moment
          // photo, // Comment this because I get an error: "accept_package_handler() got an unexpected keyword argument 'photo'"
        },
      })
    },
  },
  bridge: {
    baseUrl: baseUrlBridge,
    submitTransaction: function({ signedTransaction }) {
      return new_requestToServer(
        launcher.keypairStellar.secret(),
        launcher.keypairStellar.publicKey(),
        {
          url: this.baseUrl + '/submit_transaction',
          data: {
            transaction: signedTransaction,
          },
        }
      )
    },
    prepareAccount: function({ from_pubkey, new_pubkey }) {
      return new_requestToServer(
        launcher.keypairStellar.secret(),
        launcher.keypairStellar.publicKey(),
        {
          url: this.baseUrl + '/prepare_account',
          data: {
            from_pubkey,
            new_pubkey,
          },
        }
      )
    },
    prepareTrust: function({ from_pubkey }) {
      return new_requestToServer(
        launcher.keypairStellar.secret(),
        launcher.keypairStellar.publicKey(),
        {
          url: this.baseUrl + '/prepare_trust',
          data: {
            from_pubkey,
          },
        }
      )
    },
    prepareEscrow: function(
      userSecret,
      userPubkey,
      {
        launcher_pubkey,
        courier_pubkey,
        recipient_pubkey,
        payment_buls,
        collateral_buls,
        deadline_timestamp,
      }
    ) {
      return new_requestToServer(userSecret, userPubkey, {
        url: this.baseUrl + '/prepare_escrow',
        data: {
          launcher_pubkey,
          courier_pubkey,
          recipient_pubkey,
          payment_buls,
          collateral_buls,
          deadline_timestamp,
        },
      })
    },
    prepareSendBuls: function({ from_pubkey, to_pubkey, amount_buls }) {
      return new_requestToServer(
        launcher.keypairStellar.secret(),
        launcher.keypairStellar.publicKey(),
        {
          url: this.baseUrl + '/prepare_send_buls',
          data: {
            from_pubkey,
            to_pubkey,
            amount_buls,
          },
        }
      )
    },
  },
  fund: {
    baseUrl: baseUrlFund,
    prepareAccount: function() {
      console.log(this.baseUrl)
    },
  },
}

function new_requestToServer(userSecret, userPublic, { url, data }) {
  try {
    var fingerprint = generateFingerprint(url, data)
    var signature = signFingerprint(fingerprint, userSecret)

    var formData = objectToFormData(data)

    return $.ajax({
      type: 'POST',
      url: url,
      data: formData,
      dataType: 'json',
      processData: false,
      contentType: false,
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Pubkey', userPublic)
        xhr.setRequestHeader(
          'Fingerprint',
          unescape(encodeURIComponent(fingerprint))
        )
        xhr.setRequestHeader('Signature', signature)
      },
    })
  } catch (error) {
    console.error(error)
    alert('An error has occurred. Details in the Developer Console.')

    return null
  }
}

function requestToServer({ uri, data, response }) {
  try {
    var url = baseUrl + uri

    var fingerprint = generateFingerprint(url, data)
    var signature = signFingerprint(
      fingerprint,
      launcher.keypairStellar.secret()
    )

    var formData = objectToFormData(data)

    $.ajax({
      type: 'POST',
      url: url,
      data: formData,
      dataType: 'json',
      processData: false,
      contentType: false,
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Pubkey', launcher.keypairStellar.publicKey())
        xhr.setRequestHeader('Fingerprint', fingerprint)
        xhr.setRequestHeader('Signature', signature)
      },
      success: function(result) {
        response(result)
      },
      error: function(result) {
        response(result)
      },
    })
  } catch (error) {
    console.error(error)
    alert('An error has occurred. Details in the Developer Console.')
  }
}

function printResponse(selectorPanel, response) {
  $(selectorPanel + '#responseFormGroup').show()

  $(selectorPanel + '#response')
    .empty()
    .append(JSON.stringify(response))
}

function objectToFormData(data = null) {
  var formData = new FormData()

  if (!data) return formData

  for (var key in data) {
    formData.append(key, data[key])
  }

  return formData
}

function generateFingerprint(uri, kwargs = null) {
  if (kwargs == null) {
    kwargstring = ''
  } else {
    var ert = ['']
    for (var key in kwargs) {
      ert.push(`${key}=${kwargs[key]}`)
    }
    kwargstring = ert.join(',')
  }
  return `${uri}${kwargstring},${Date.now() * 1000}`
}

function signFingerprint(fingerprint, secret) {
  var fingerprintBuffer = stringToArrayBuffer(fingerprint)
  var signature = StellarBase.Keypair.fromSecret(secret).sign(fingerprintBuffer)
  return arrayBufferToBase64(signature)
}

function signTransaction(transaction, keypairStellar) {
  var transactionStellar = new StellarBase.Transaction(transaction)
  transactionStellar.sign(keypairStellar)
  var transactionEnvelope = transactionStellar.toEnvelope()
  var resultXDR = arrayBufferToBase64(transactionEnvelope.toXDR())
  return resultXDR
}

function stringToArrayBuffer(str) {
  var bytes = []
  for (var i = 0; i < str.length; i++) {
    var char = str.charCodeAt(i)
    bytes.push(char >>> 8)
    bytes.push(char & 0xff)
  }
  return bytes
}

function arrayBufferToBase64(buffer) {
  var binary = ''
  var bytes = new Uint8Array(buffer)
  var len = bytes.byteLength
  for (var i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i])
  }
  return window.btoa(binary)
}

// Save escrow Pubkey/Secret (escrowKeypair) to local storage
function saveKeypairForPackage(
  escrowKeypair,
  courierKeypair,
  launcherKeypair,
  recipientKeypair
) {
  var listKeypair = getKeypairForPackage()
  listKeypair.push({
    escrow: {
      privateKey: escrowKeypair.secret(),
      publicKey: escrowKeypair.publicKey(),
    },
    launcher: {
      privateKey: launcherKeypair.secret(),
      publicKey: launcherKeypair.publicKey(),
    },
    courier: {
      privateKey: courierKeypair.secret(),
      publicKey: courierKeypair.publicKey(),
    },
    recipient: {
      privateKey: recipientKeypair.secret(),
      publicKey: recipientKeypair.publicKey(),
    },
  })
  localStorage.setItem('keypairForPackages', JSON.stringify(listKeypair))
}

function getKeypairForPackage() {
  var listKeypair = JSON.parse(localStorage.getItem('keypairForPackages')) || []
  return listKeypair
}

// Save description for create package
function saveDescriptionForCreatePackage(description) {
  var descriptions = getDescriptionForCreatePackage()

  descriptions.unshift(description)
  descriptions.splice(5)

  localStorage.setItem('descriptionAutofill', JSON.stringify(descriptions))
}

function getDescriptionForCreatePackage() {
  var descriptions =
    JSON.parse(localStorage.getItem('descriptionAutofill')) || []
  return descriptions
}

// Property for array
Array.prototype.last = function() {
  return this[this.length - 1]
}

// UiLoadingScreen
function showLoadingScreen(info = '') {
  $('#loadingScreen').show()
  $('#loadingScreen #info').text(info)
}

function infoLoadingScreen(info = '') {
  $('#loadingScreen #info').text(info)
}

function hideLoadingScreen() {
  $('#loadingScreen').hide()
}

// Conwert date time
function dateToYMD(date) {
  var strArray = [
    'Jan',
    'Feb',
    'Mar',
    'Apr',
    'May',
    'Jun',
    'Jul',
    'Aug',
    'Sep',
    'Oct',
    'Nov',
    'Dec',
  ]
  var d = date.getDate()
  var m = strArray[date.getMonth()]
  var y = date.getFullYear()
  return '' + (d <= 9 ? '0' + d : d) + ' ' + m + ' ' + y
}

function changesCheckBoxEnterDescription(checkBox) {
  if (checkBox.checked == true) {
    $('#createPackageModal #description').show()
  } else {
    $('#createPackageModal #description').hide()
  }
}
